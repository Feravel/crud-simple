<!DOCTYPE html>
<html>
    <head>
        <title>CRUD Test</title>
        <link rel="stylesheet" href="style.css">
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    </head>

    <body>
        <div class="mt-5 rounded outline-2 outline-red-400 outline-offset-3 bg-red-200 container mx-auto p-2 align-center items-center text-center flex flex-col">
            <h1 class="-translate-y-10 text-4xl bg-red-400 pt-4 pb-4 rounded p-5 text-white">CRUD Test</h1>
            <div class="text-red-500">
                <h2 class="mb-4">Form</h2>
                <input id="title" placeholder="Title" class="bg-white shadow-md rounded px-8 pt-3 pb-3 mb-3">
                <input id="description" placeholder="Description" class="bg-white shadow-md rounded px-8 pt-3 pb-3 mb-3">
                <button onclick="addTask()" class="bg-red-400 hover:bg-red-700 text-white font-bold py-3 px-4 rounded">Add</button>
            </div>
            <div class="m-3">
                <!--Acá spawnean los elementos de la db-->
                <ul id="tasks"></ul>
            </div>
        </div>

        <script>
            //CARGA LA BASE DE DATOS
            async function loadTasks() {
                const res = await fetch("/tasks");
                const tasks = await res.json();
                const list = document.getElementById("tasks");
                list.innerHTML = `
                    <table class="text-white table-auto rounded mb-2 p-2 w-full">
                        <tr class="grid grid-cols-4 text-xl pb-2 ">
                            <th class="bg-red-400 ml-2 mr-2 pb-3 pt-3 rounded">Title</th>
                            <th class="bg-red-400 ml-2 mr-2 pb-3 pt-3 rounded">Description</th>
                            <th class="bg-red-400 ml-2 mr-2 pb-3 pt-3 rounded">Status</th>
                            <th class="bg-red-400 ml-2 mr-2 pb-3 pt-3 rounded">Actions</th>
                        </tr>
                    </table>
                `;
                tasks.forEach(t => {
                    const li = document.createElement("li");
                    //Title: Description - Status
                    li.innerHTML = `
                        <table class="align-middle table-auto text-red-700  mb-2 p-2 w-full">
                            <tr class="grid grid-cols-4 ">
                                <td class="bg-red-300 rounded ml-2 mr-2 pt-3">${t.title}</td>
                                <td class="bg-red-300 rounded ml-2 mr-2 pt-3">${t.description}</td>
                                <td class="bg-red-300 rounded ml-2 mr-2 pt-3">${t.completed ? "Done" : "Pending"}</td>
                                <td class="grid grid-cols-5 gap-2">
                                    <button class="btn outline" onclick="deleteTask(${t.id})">X</button>
                                    <button class="col-span-2 btn outline" onclick="updateTask(${t.id},'${t.description}')">Edit Description</button>
                                    <button class="col-span-2 btn outline" onclick="toggleCompleted(${t.id}, ${t.completed})">
                                        ${t.completed ? "Undo" : "Complete"}
                                    </button>
                                </td>
                            </tr>
                        </table>
                        
                    `;
                    list.appendChild(li);
                });
            }

            //AÑADE LINEA A BASE DE DATOS
            async function addTask() {
                const title = document.getElementById("title").value;
                const description = document.getElementById("description").value;
                await fetch("/tasks", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ title, description })
                });
                document.getElementById("title").value = "";
                document.getElementById("description").value = ""; //LIMPIA CAMPOS
                loadTasks(); //Actualiza lista
            }

            //ACTUALIZA LINEA DE BASE DE DATOS
            async function updateTask(id, description) { 
                const newDescription = prompt("Enter new description:", description);
                if (!newDescription || newDescription.trim() === "") 
                    return; //TRIM SACA LOS ESPACIOS
                console.log("TIENE ALGO ESCRITO");
                await fetch(`/tasks/${id}`, {
                    method: "PUT",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ description: newDescription })
                });
                loadTasks(); //Actualiza lista
            }

            //ELIMINA LINEA DE BASE DE DATOS
            async function deleteTask(id) {
                await fetch(`/tasks/${id}`, { method: "DELETE" });
                loadTasks(); //Actualiza lista
            }

            //ACTUALIZA ESTADO
            async function toggleCompleted(id, currentStatus) {
                await fetch(`/tasks/${id}/complete`, {
                    method: "PUT",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ completed: !currentStatus })
                });
                loadTasks(); //Actualiza lista (otra vez) :D
            }

            loadTasks();
            
        </script>
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    </body>
</html>
